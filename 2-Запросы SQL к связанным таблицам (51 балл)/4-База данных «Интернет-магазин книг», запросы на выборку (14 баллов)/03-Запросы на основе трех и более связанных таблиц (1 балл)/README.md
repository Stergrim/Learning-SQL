# Запросы на основе трех и более связанных таблиц

**Пример**

Вывести фамилии всех клиентов, которые заказали книгу Булгакова «Мастер и Маргарита».

*Запрос:*

Этот запрос строится на основе нескольких таблиц, для удобства нужно определить фрагмент логической схемы базы данных, на основе которой строится запрос. В нашем случае выбираются название книги из таблицы `book` и фамилия клиента из таблицы `client`. Эти таблицы между собой непосредственно не связаны, поэтому нужно добавить «связующие» таблицы `buy` и `buy_book`:

Для соединения этих таблиц используется `INNER JOIN`. Для удобства рекомендуется связи описывать последовательно: `client` → `buy` → `buy_book` → `book`.  А для соединения использовать пару **первичный ключ** и **внешний ключ** соответствующих таблиц. Например, соединение таблиц `client` и `buy` осуществляется по условию `client.client_id = buy.client_id`.

Чтобы не усложнять схему, будем считать, что нам известен `id` Булгакова (это 1)

```mysql
SELECT DISTINCT name_client
FROM 
    client 
    INNER JOIN buy ON client.client_id = buy.client_id
    INNER JOIN buy_book ON buy_book.buy_id = buy.buy_id
    INNER JOIN book ON buy_book.book_id=book.book_id
WHERE title ='Мастер и Маргарита' and author_id = 1; 
```

В запросе отбираются уникальные клиенты (`DISTINCT`) так как один и тот же клиент мог заказать одну и ту же книгу несколько раз.

*Результат:*

```mysql
+---------------+
| name_client   |
+---------------+
| Баранов Павел |
| Абрамова Катя |
+---------------+
```

**Задание**

Вывести все заказы Баранова Павла (`id` заказа, какие книги, по какой цене и в каком количестве он заказал) в отсортированном по номеру заказа и названиям книг виде.

Введите SQL запрос

*Результат:*

```mysql
Query result:
+--------+--------------------+--------+--------+
| buy_id | title              | price  | amount |
+--------+--------------------+--------+--------+
| 1      | Идиот              | 460.00 | 1      |
| 1      | Мастер и Маргарита | 670.99 | 1      |
| 1      | Черный человек     | 570.20 | 2      |
| 4      | Игрок              | 480.50 | 1      |
+--------+--------------------+--------+--------+
Affected rows: 4
```

```mysql
SELECT buy.buy_id, book.title, book.price, buy_book.amount
FROM client
     INNER JOIN buy ON buy.client_id = client.client_id
     INNER JOIN buy_book ON buy_book.buy_id = buy.buy_id
     INNER JOIN book ON book.book_id = buy_book.book_id
WHERE name_client = 'Баранов Павел'
ORDER BY buy.buy_id, book.title;
```

Вы получили: 1 балл из 1
